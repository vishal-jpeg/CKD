trigger: none

stages:
  - stage: MergeAndDeploy
    jobs:
      - job: MergeParamsAndDeploy
        pool:
          vmImage: 'windows-latest'

        steps:
          - checkout: self

          - task: PowerShell@2
            name: MergeBicepParams
            inputs:
              targetType: 'inline'
              pwsh: true
              script: |
                $paramFile1 = "$(System.DefaultWorkingDirectory)/CTB/canada_central/common_services/common/Connect/Sandbox/baseFirewall.json"
                $paramFile2 = "$(System.DefaultWorkingDirectory)/CTB/canada_central/common_services/common/Connect/Sandbox/rcg-sb-default-01.json"
                $outputFile = "$(System.DefaultWorkingDirectory)/CTB/canada_central/common_services/common/Connect/Sandbox/mergedParams.json"

                function Read-JsonParamFile {
                    param (
                        [string]$filePath
                    )
                    $jsonContent = Get-Content -Raw -Path $filePath | ConvertFrom-Json
                    return $jsonContent.parameters
                }

                $params1 = Read-JsonParamFile -filePath $paramFile1
                $params2 = Read-JsonParamFile -filePath $paramFile2

                # Merge logic
                $mergedParams = @{}

                $params1.PSObject.Properties | ForEach-Object {
                    $mergedParams[$_.Name] = @{ value = $_.Value.value }
                }

                $params2.PSObject.Properties | ForEach-Object {
                    $mergedParams[$_.Name] = @{ value = $_.Value.value }
                }

                # Final JSON structure
                $finalJson = @{
                    '$schema' = 'https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#'
                    contentVersion = '1.0.0.0'
                    parameters = $mergedParams
                }

                # Save to output file
                $finalJson | ConvertTo-Json -Depth 10 | Out-File -FilePath $outputFile -Encoding utf8
                Write-Host "âœ… Merged parameter file created at: $outputFile"

          - task: AzureCLI@2
            name: DeployMainBicep
            inputs:
              azureSubscription: 'YOUR-AZURE-SERVICE-CONNECTION-NAME'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $mergedParamFile = "$(System.DefaultWorkingDirectory)/CTB/canada_central/common_services/common/Connect/Sandbox/mergedParams.json"
                $templateFile = "$(System.DefaultWorkingDirectory)/CTB/canada_central/common_services/common/Connect/Sandbox/main.bicep"

                az deployment sub create `
                  --location canada-central `
                  --template-file $templateFile `
                  --parameters @$mergedParamFile
