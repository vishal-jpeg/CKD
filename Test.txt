# Step 3: Audit each permission
foreach ($permName in $permissionsToCheck) {
    Write-Host "`nüîé Auditing permission: $permName"
    $foundMatch = $false
    
    # Find all relevant ACL entries
    $relevantEntries = $allTokenPermissions | Where-Object {
        $_.permissionDisplayName -and 
        ($_.permissionDisplayName.Trim() -eq $permName.Trim()) -and
        ($allSubjectsToCheck -contains $_.subjectDescriptor)
    }

    if ($relevantEntries) {
        foreach ($entry in $relevantEntries) {
            $foundMatch = $true
            $source = if ($entry.subjectDescriptor -eq $subject) {
                "EXPLICIT"
            } else {
                "INHERITED [$($entry.subjectDescriptor)]"
            }

            if ($entry.allow -gt 0) {
                Write-Host " ‚úÖ ALLOWED ($source)"
            } 
            elseif ($entry.deny -gt 0) {
                Write-Host " üö´ DENIED ($source)"
            }
            else {
                Write-Host " ‚ö†Ô∏è NEUTRAL ($source) - Neither allowed nor denied"
            }
        }
    }
    
    if (-not $foundMatch) {
        # Check if permission exists for other subjects
        $permissionExists = $allTokenPermissions | Where-Object {
            $_.permissionDisplayName -and 
            ($_.permissionDisplayName.Trim() -eq $permName.Trim())
        }
        
        if ($permissionExists) {
            Write-Host " ‚ùå NOT SET for subject/groups (but exists for others)"
        } else {
            Write-Host " ‚ùå NOT SET in any ACL entries"
        }
    }
}
