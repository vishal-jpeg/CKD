# Setup
$org = "https://dev.azure.com/cantirebank/"
$namespaceId = "2e9eb7ed-3c0a-47d4-87c1-0ffdd275fd87"
$projectId = $ProjectDetails.id
$repoId = $repold
$token = "repoV2/$projectId/$repoId"
$subject = $groupDescriptor

$permissionsToCheck = @(
  "Advanced Security: manage and dismiss alerts",
  "Advanced Security: manage settings",
  "Advanced Security: view alerts",
  "Read"
)

# Step 1: Get all ACL entries set on this token (repo), including inherited
Write-Host "üîç Fetching all permission entries set on token: $token"

$rawJson = az devops security permission list `
  --namespace-id $namespaceId `
  --token $token `
  --recurse `
  --organization $org `
  --output json

$allTokenPermissions = $rawJson | ConvertFrom-Json

# Step 2: Filter those entries to only those applying to our subject (or its parent groups)

# Fetch all groups this subject is a member of
Write-Host "`nüîÑ Resolving group memberships for subject..."
$subjectMembershipsJson = az devops security group membership list `
  --id $subject `
  --organization $org `
  --output json

$subjectGroups = ($subjectMembershipsJson | ConvertFrom-Json).members
$allSubjectsToCheck = @($subject) + $subjectGroups  # Direct + parent groups

# Step 3: Filter permissions matching our subject or inherited groups
foreach ($permName in $permissionsToCheck) {
  Write-Host "`nüîé Auditing permission: $permName"

  $entry = $allTokenPermissions | Where-Object {
    ($allSubjectsToCheck -contains $_.subjectDescriptor) -and
    ($_.permissionDisplayName -eq $permName)
  }

  if ($entry) {
    if ($entry.allow -gt 0) {
      if ($entry.subjectDescriptor -eq $subject) {
        Write-Host "  ‚úÖ [$permName] is EXPLICITLY ALLOWED"
      } else {
        Write-Host "  üì• [$permName] is INHERITED via group [$($entry.subjectDescriptor)]"
      }
    } elseif ($entry.deny -gt 0) {
      Write-Host "  üö´ [$permName] is DENIED"
    } else {
      Write-Host "  ‚ö†Ô∏è [$permName] exists but not allowed or denied"
    }
  } else {
    Write-Host "  ‚ùå [$permName] is NOT SET and NOT INHERITED"
  }
}
