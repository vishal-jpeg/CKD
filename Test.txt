param (
    [string]$paramFile1 = "/location/Sandbox/param1.bicepparam",
    [string]$paramFile2 = "/location/Sandbox/param2.bicepparam"
)

# Function to read .bicepparam file and convert to JSON
function Read-BicepParamFile {
    param (
        [string]$filePath
    )
    $json = az bicep build-params --file $filePath --stdout | ConvertFrom-Json
    return $json
}

# Read both parameter files
$params1 = Read-BicepParamFile -filePath $paramFile1
$params2 = Read-BicepParamFile -filePath $paramFile2

# Construct the final merged JSON with nested parameter sets
$finalJson = @{
    '$schema'       = 'https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#'
    contentVersion  = '1.0.0.0'
    parameters      = @{
        paramSet1 = @{
            value = $params1.parameters
        }
        paramSet2 = @{
            value = $params2.parameters
        }
    }
}

# Convert to JSON and print the output
$output = $finalJson | ConvertTo-Json -Depth 10 -Compress
Write-Warning "output: $output"
