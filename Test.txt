param (
  [string]$AzureDevOpsOrgUrl = "https://dev.azure.com/cantirebank",
  [string]$KeyVaultName = "ctb-ac-sb-co-kv-pat-01",
  [string]$SecretName = "AutomationPAT-token",
  [string]$ServiceAccountUPN = "JaishnuTestUser@ctbank.ctfs.com"
)

# Use MSAL token (delegated user token from App Registration)
$accessToken = "<YOUR_ENTRA_ACCESS_TOKEN>"

$headers = @{
  Authorization = "Bearer $accessToken"
  "Content-Type" = "application/json"
}

$body = @{
  displayName = "Auto-Rotated-PAT"
  scope = "vso.work_write vso.code_write"
  validTo = (Get-Date).AddDays(30).ToString("o")
  allOrgs = $false
  onlyWithinCurrentAccount = $true
  isPublic = $false
  userPrincipalName = $ServiceAccountUPN
} | ConvertTo-Json -Depth 10

$apiurl = "https://vssps.dev.azure.com/cantirebank/_apis/tokens/pats?api-version=7.1-preview.1"

$response = Invoke-RestMethod -Method Post -Uri $apiurl -Headers $headers -Body $body

$newPat = $response.patToken.token

if (-not $newPat) {
  throw "Failed to retrieve new PAT. Response: $($response | ConvertTo-Json -Depth 5)"
}

Set-AzKeyVaultSecret -VaultName $KeyVaultName -Name $SecretName -SecretValue (ConvertTo-SecureString $newPat -AsPlainText -Force)

Write-Output "PAT rotation completed successfully."
