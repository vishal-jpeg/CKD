# 1️⃣ Connect to Microsoft Graph with required permissions
Connect-MgGraph -Scopes "RoleManagement.ReadWrite.Directory", "RoleManagementPolicy.ReadWrite.AzureAD"

# 2️⃣ Get the Subscription Scope ID for Sandbox
$subscriptionId = "<YOUR_SANDBOX_SUBSCRIPTION_ID>"
$scope = "/subscriptions/$subscriptionId"

# 3️⃣ Find the Role Management Policy for the 'Reader' role
$policy = Get-MgPolicyRoleManagementPolicy | Where-Object { $_.ScopeId -eq $scope -and $_.DisplayName -like "*Reader*" }

if (-not $policy) { 
    Write-Host "❌ Error: No Role Management Policy found for Reader in the Sandbox subscription!" 
    exit 1
}

Write-Host "✅ Found Policy: $($policy.DisplayName) with ID: $($policy.Id)"

# 4️⃣ Retrieve the expiration policy rule for the Reader role
$policyRule = Get-MgPolicyRoleManagementPolicyRule -UnifiedRoleManagementPolicyId $policy.Id | Where-Object { $_.Id -like "*Expiration*" }

if (-not $policyRule) { 
    Write-Host "❌ Error: No expiration policy rule found for Reader!" 
    exit 1
}

Write-Host "✅ Found Expiration Rule: $($policyRule.Id)"

# 5️⃣ Update the policy to make the role eligibility permanent (disable expiration)
$params = @{
    "@odata.type" = "#microsoft.graph.unifiedRoleManagementPolicyExpirationRule"
    id = $policyRule.Id
    isExpirationRequired = $false   # Set to false (No Expiration)
    maximumDuration = "P0D"         # No duration limit
}

Update-MgPolicyRoleManagementPolicyRule -UnifiedRoleManagementPolicyId $policy.Id -UnifiedRoleManagementPolicyRuleId $policyRule.Id -BodyParameter $params

Write-Host "✅ Reader Role in Sandbox Subscription is now set to PERMANENT eligibility!"
