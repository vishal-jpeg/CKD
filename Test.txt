param (
    [string]$paramFile1 = "/location/Sandbox/param1.bicepparam",
    [string]$paramFile2 = "/location/Sandbox/param2.bicepparam"
)

# Function to read .bicepparam file and convert to JSON
function Read-BicepParamFile {
    param (
        [string]$filePath
    )
    $json = az bicep build-params --file $filePath --stdout | ConvertFrom-Json
    return $json
}

# Read both param files
$params1 = Read-BicepParamFile -filePath $paramFile1
$params2 = Read-BicepParamFile -filePath $paramFile2

# Merge parameters
$mergedParams = $params1.parameters.PSObject.Properties + $params2.parameters.PSObject.Properties

# Final merged param dictionary
$finalParams = @{}
foreach ($param in $mergedParams) {
    $finalParams[$param.Name] = $param.Value
}

# Recreate full JSON output like az bicep does
$finalJson = @{
    '$schema' = 'https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#'
    contentVersion = '1.0.0.0'
    parameters = $finalParams
}

# Convert to JSON and print to console
$output = $finalJson | ConvertTo-Json -Depth 10 -Compress
Write-Warning "output: $output"
