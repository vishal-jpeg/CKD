- task: PowerShell@2
  displayName: 'Connect and Verify Microsoft Graph'
  inputs:
    targetType: 'inline'
    script: |
      Install-Module Microsoft.Graph -Scope CurrentUser -Force -AllowClobber

      $accessToken = "$(accessToken)"
      Connect-MgGraph -AccessToken $accessToken -NoWelcome

      try {
          $me = Get-MgUser -UserId 'me'
          Write-Host "Successfully connected to Microsoft Graph as: $($me.DisplayName)"
      } catch {
          Write-Error "Microsoft Graph connection failed: $_"
          throw
      }
