$csvPath = "/agent/_work/1/s/CTB/TemplateFiles/CSVS/PIM.csv"
$entries = Import-Csv -Path $csvPath

foreach ($entry in $entries) {
    $Scope           = $entry.Scope
    $AssignmentScope = $entry.AssignmentScope
    $StartTime       = Get-Date -Format o

    # ─── 1) RESOLVE ROLE DEFINITION ID ────────────────────────────────────────────
    $roleName = $entry.RoleDefinition
    # Try by built-in Name first; if that fails, look up by DisplayName
    try {
        $roleObj = Get-AzRoleDefinition -Name $roleName -ErrorAction Stop
    }
    catch {
        $roleObj = Get-AzRoleDefinition -Filter "properties/displayName eq '$roleName'" -ErrorAction Stop
    }
    $RoleDefinitionId = $roleObj.Id

    # ─── 2) RESOLVE PRINCIPAL ID ──────────────────────────────────────────────────
    $principalName = $entry.Principal
    # Try user by UPN or displayName
    $adUser = Get-AzADUser -Filter "userPrincipalName eq '$principalName' or displayName eq '$principalName'" `
              -ErrorAction SilentlyContinue
    if ($adUser) {
        $PrincipalId = $adUser.Id
    }
    else {
        # Fallback to group by displayName
        $adGroup = Get-AzADGroup -Filter "displayName eq '$principalName'" -ErrorAction Stop
        $PrincipalId = $adGroup.Id
    }

    # ─── 3) UPDATE ROLE MANAGEMENT POLICY ─────────────────────────────────────────
    $GetPolicy = Get-AzRoleManagementPolicyAssignment -Scope $Scope `
                   | Where-Object Name -like "*$($entry.RoleId)"
    $PolicyId  = ($GetPolicy.PolicyId -split "/")[-1]

    # (re-use your existing rule objects here…)
    $AllRules = [Microsoft.Azure.PowerShell.Cmdlets.Resources.Authorization.Models.Api20201001Preview.IRoleManagementPolicyRule[]]@(
        $ExpirationRuleAdminEligible,
        $ExpirationRuleAdminActive,
        $EnablementRuleAdmin
    )
    Update-AzRoleManagementPolicy -Scope $Scope -Name $PolicyId -Rule $AllRules

    # ─── 4) SKIP OR CREATE ELIGIBILITY ────────────────────────────────────────────
    $allSchedules = Get-AzRoleEligibilityScheduleRequest `
        -Scope $AssignmentScope `
        -Filter "principalId eq '$PrincipalId'" `
        -ErrorAction SilentlyContinue

    $existing = $allSchedules | Where-Object {
        $_.RoleDefinitionId -eq $RoleDefinitionId -and
        $_.Scope            -eq $AssignmentScope
    }

    if ($existing) {
        Write-Host "Skipping—eligibility already exists for '$principalName' as '$roleName'"
        continue
    }

    # Create new eligibility schedule
    $params = @{
        Name                      = [Guid]::NewGuid().ToString()
        Scope                     = $AssignmentScope
        PrincipalId               = $PrincipalId
        RoleDefinitionId          = $RoleDefinitionId
        RequestType               = "AdminAssign"
        ScheduleInfoStartDateTime = $StartTime
        Duration                  = $entry.Duration
        Justification             = $entry.Justification
    }
    New-AzRoleEligibilityScheduleRequest @params
}

# ─── CONFIG ───────────────────────────────────────────────────────────────────────
$csvPath = "/agent/_work/1/s/CTB/TemplateFiles/CSVS/PIM.csv"
$entries = Import-Csv -Path $csvPath

# (Optional) Default values for PIM schedule:
$DefaultDuration     = "P30D"
$DefaultJustification = "Auto-assigned via script"

foreach ($entry in $entries) {

    # ─── 1) PARSE CSV ROW ──────────────────────────────────────────────────────────
    $Scope               = $entry.Scope
    $roleDefName         = $entry.RoleDefinitionName
    $principalName       = $entry.PrincipalName
    $startTime           = (Get-Date).ToString('o')

    # ─── 2) RESOLVE ROLE DEFINITION → ID ─────────────────────────────────────────
    $roleDef = Get-AzRoleDefinition -Name $roleDefName -ErrorAction Stop
    $roleDefId = $roleDef.Id

    # ─── 3) RESOLVE PRINCIPAL → ID ───────────────────────────────────────────────
    $adUser = Get-AzADUser -Filter "userPrincipalName eq '$principalName' or displayName eq '$principalName'" `
               -ErrorAction SilentlyContinue
    if ($adUser) {
        $principalId = $adUser.Id
    }
    else {
        $adGroup     = Get-AzADGroup -Filter "displayName eq '$principalName'" -ErrorAction Stop
        $principalId = $adGroup.Id
    }

    # ─── 4) FIND YOUR POLICY ASSIGNMENT ──────────────────────────────────────────
    #    by matching RoleDefinitionId at that same Scope
    $policyAssign = Get-AzRoleManagementPolicyAssignment -Scope $Scope |
                     Where-Object RoleDefinitionId -eq $roleDefId

    $policyId           = ($policyAssign.PolicyId -split "/")[-1]
    $currentRoleDefId   = $policyAssign.RoleDefinitionId

    # ─── 5) UPDATE POLICY ASSIGNMENT RULES (if needed) ──────────────────────────
    #    (reuse your existing rule objects here)
    $AllRules = [Microsoft.Azure.PowerShell.Cmdlets.Resources.Authorization.Models.Api20201001Preview.IRoleManagementPolicyRule[]]@(
        $ExpirationRuleAdminEligible,
        $ExpirationRuleAdminActive,
        $EnablementRuleAdmin
    )
    Update-AzRoleManagementPolicy -Scope $Scope -Name $policyId -Rule $AllRules

    # ─── 6) CHECK FOR EXISTING PIM ELIGIBILITY ────────────────────────────────────
    #  (filter server-side by principal, then client-side by role+scope)
    $allSchedules = Get-AzRoleEligibilityScheduleRequest `
        -Scope $Scope `
        -Filter "principalId eq '$principalId'" `
        -ErrorAction SilentlyContinue

    $already = $allSchedules | Where-Object {
        $_.RoleDefinitionId -eq $roleDefId -and
        $_.Scope           -eq $Scope
    }

    if ($already) {
        Write-Host "Skipping: eligibility already exists for '$principalName' on role '$roleDefName'."
        continue
    }

    # ─── 7) CREATE NEW PIM ELIGIBILITY ───────────────────────────────────────────
    $params = @{
        Name                      = [Guid]::NewGuid().ToString()
        Scope                     = $Scope
        PrincipalId               = $principalId
        RoleDefinitionId          = $roleDefId
        RequestType               = "AdminAssign"
        ScheduleInfoStartDateTime = $startTime
        Duration                  = $DefaultDuration
        Justification             = $DefaultJustification
    }
    New-AzRoleEligibilityScheduleRequest @params -ErrorAction Stop

    Write-Host "Created eligibility for '$principalName' on role '$roleDefName'."
}
