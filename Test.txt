# 1) Define the permissions you want to check
$targetPerms = @(
  "Advanced Security: manage and dismiss alerts",
  "Advanced Security: manage settings",
  "Advanced Security: view alerts",
  "Read"
)

# 2) Fetch the permission JSON from Azure DevOps
$permissionsJson = az devops security permission show `
  --namespace-id "2e9eb7ed-3c0a-47d4-87c1-0ffdd275fd87" `
  --subject $groupDescriptor `
  --token "repoV2/$projectId/$repoId" `
  --organization $org `
  --output json

# 3) Convert to object
$permissions = $permissionsJson | ConvertFrom-Json

# 4) Filter and display only the desired permissions
$filteredPermissions = $permissions.resolvedPermissions |
  Where-Object { $targetPerms -contains $_.displayName } |
  Select-Object @{Name='Permission';Expression={$_.displayName}}, 
                @{Name='Effective';Expression={$_.effectivePermission}}

# 5) Display clean table
Write-Host "`nðŸŽ¯ Filtered Permission Audit:"
$filteredPermissions | Format-Table -AutoSize
