# ----------------------------------------
# Setup basic inputs
# ----------------------------------------

$org = "https://dev.azure.com/cantirebank/"
$projectName = "ctb-prj-mb-infra-01"
$repoName = "ctb-rep-mb-01"
$subject = "vssgp.Uy0xLTktMT..."  # Replace with your actual groupDescriptor

# Permissions to audit
$permissionsToCheck = @(
  "Advanced Security: manage and dismiss alerts",
  "Advanced Security: manage settings",
  "Advanced Security: view alerts",
  "Read"
)

# ----------------------------------------
# Step 0: Fetch projectId and repoId
# ----------------------------------------

Write-Host "`nüîç Getting project ID for: $projectName"
$projectId = az devops project show `
  --project $projectName `
  --organization $org `
  --query id `
  --output tsv

Write-Host "üì¶ projectId = $projectId"

Write-Host "`nüîç Getting repository ID for: $repoName"
$repoId = az repos show `
  --repository $repoName `
  --project $projectName `
  --organization $org `
  --query id `
  --output tsv

Write-Host "üì¶ repoId = $repoId"

# ----------------------------------------
# Step 1: Prepare namespace and token
# ----------------------------------------

$namespaceId = "2e9eb7ed-3c0a-47d4-87c1-0ffdd275fd87"  # Git repos namespace
$token = "repoV2/$projectId/$repoId"

# ----------------------------------------
# Step 2: Get all ACL entries on this token (including inherited)
# ----------------------------------------

Write-Host "`nüîç Fetching all permission entries set on token: $token"

$rawJson = az devops security permission list `
  --namespace-id $namespaceId `
  --token $token `
  --recurse `
  --organization $org `
  --output json

$allTokenPermissions = $rawJson | ConvertFrom-Json

# ----------------------------------------
# Step 3: Fetch all groups this subject is a member of
# ----------------------------------------

Write-Host "`nüîÑ Resolving group memberships for subject: $subject"

$subjectMembershipsJson = az devops security group membership list `
  --id $subject `
  --organization $org `
  --output json

$subjectGroups = ($subjectMembershipsJson | ConvertFrom-Json).members
$allSubjectsToCheck = @($subject) + $subjectGroups

# ----------------------------------------
# Step 4: Audit permissions
# ----------------------------------------

foreach ($permName in $permissionsToCheck) {
  Write-Host "`nüîé Auditing permission: $permName"

  $entry = $allTokenPermissions | Where-Object {
    ($allSubjectsToCheck -contains $_.subjectDescriptor) -and
    ($_.permissionDisplayName -eq $permName)
  }

  if ($entry) {
    if ($entry.allow -gt 0) {
      if ($entry.subjectDescriptor -eq $subject) {
        Write-Host "  ‚úÖ [$permName] is EXPLICITLY ALLOWED"
      } else {
        Write-Host "  üì• [$permName] is INHERITED via group [$($entry.subjectDescriptor)]"
      }
    } elseif ($entry.deny -gt 0) {
      Write-Host "  üö´ [$permName] is DENIED"
    } else {
      Write-Host "  ‚ö†Ô∏è [$permName] exists but not allowed or denied"
    }
  } else {
    Write-Host "  ‚ùå [$permName] is NOT SET and NOT INHERITED"
  }
}
