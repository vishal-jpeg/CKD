trigger: none

name: Deploy Bicep files with Master Param File

parameters:
  - name: runvalidation
    displayName: "Run Validation and Scan"
    type: boolean
    default: true

  - name: templateFileDirectory
    displayName: "Template File Directory"
    type: string
    default: ./CTB/TemplateFiles

variables:
  azureServiceConnection: 'ctb-ac-sb-connect'
  location: 'canadacentral'
  templateFile: './CTB/canada_central/common_services/common/Connect/Sandbox/firewallPolicy.bicep'
  parameterFile: './CTB/canada_central/common_services/common/Connect/Sandbox/master.bicepparam'

pool:
  name: Merchantss

stages:
  - stage: Lint
    displayName: Validate Bicep
    jobs:
      - job: LintCode
        displayName: Lint and Validate
        condition: and(succeeded(), eq('${{ parameters.runvalidation }}', true))
        steps:
          - task: AzureCLI@2
            displayName: Run Bicep Build
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                mkdir -p ${{ parameters.templateFileDirectory }}/JsonFilesForScan
                az bicep build --file $(templateFile) --outdir ${{ parameters.templateFileDirectory }}/JsonFilesForScan

          - task: AzureCLI@2
            displayName: Preflight Validation
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az deployment sub validate \
                  --subscription 35909696-9868-4f63-b66b-d3178b513770 \
                  --location $(location) \
                  --template-file $(templateFile) \
                  --parameters @$(parameterFile)

          - task: AzureCLI@2
            displayName: What-if Preview
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az deployment sub what-if \
                  --subscription 35909696-9868-4f63-b66b-d3178b513770 \
                  --location $(location) \
                  --template-file $(templateFile) \
                  --parameters @$(parameterFile)

  - stage: Deploy
    displayName: Deploy Stage
    jobs:
      - deployment: DeployResource
        displayName: Deploy Resource
        environment: ctb-ac-env-sb-01
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: Deploy Bicep File
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az deployment sub create \
                        --subscription 35909696-9868-4f63-b66b-d3178b513770 \
                        --location $(location) \
                        --template-file $(templateFile) \
                        --parameters @$(parameterFile)
