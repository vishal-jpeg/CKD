param (
    [string]$AzureDevOpsOrgUrl,
    [string]$ServiceAccountUsername,
    [string]$ServiceAccountPassword,  # Consider storing this securely as a secret as well
    [string]$KeyVaultName,
    [string]$SecretName
)

# Connect to Azure DevOps
$pat = ConvertTo-SecureString $ServiceAccountPassword -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential ($ServiceAccountUsername, $pat)
Connect-AzAccount -Identity  # Runbook uses Managed Identity

# Rotate PAT via Azure DevOps API (invoke REST call)
$body = @{
    displayName = "automation-pat"
    scope       = "vso.build vso.code"
    validTo     = (Get-Date).AddDays(30).ToString("o")
    allOrgs     = $false
}
$response = Invoke-RestMethod -Method Post -Uri "$AzureDevOpsOrgUrl/_apis/tokens/pats?api-version=7.0" -Credential $cred -Body ($body | ConvertTo-Json -Depth 10) -ContentType "application/json"

$newPat = $response.patToken

# Store PAT in Key Vault
Set-AzKeyVaultSecret -VaultName $KeyVaultName -Name $SecretName -SecretValue (ConvertTo-SecureString $newPat -AsPlainText -Force)
