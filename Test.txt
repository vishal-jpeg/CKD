# Install/Update Microsoft Graph module
Install-Module Microsoft.Graph -Scope CurrentUser -Force
Import-Module Microsoft.Graph

# Connect to Microsoft Graph
Connect-MgGraph -Scopes "PrivilegedAccess.ReadWrite.AzureResources"

# Define variables (use your subscription ID)
$subscriptionId = "e1732281-2c8e-478d-9669-196e46ab1875"
$readerRoleId = "acdd72a7-3385-48ef-bd42-f606fba81ae7" # Reader role GUID

# Fetch PIM policies for the subscription
$policies = Get-MgPolicyRoleManagementPolicy -Filter "scopeId eq '/subscriptions/$subscriptionId'"
$readerPolicy = $policies | Where-Object { $_.RoleDefinitionId -eq $readerRoleId }

# Retrieve expiration rules
$rules = Get-MgPolicyRoleManagementPolicyRule -UnifiedRoleManagementPolicyId $readerPolicy.Id
$expirationRule = $rules | Where-Object { $_.RuleType -eq "Expiration_Admin_Eligibility" }

# Update the rule to allow permanent assignments
$params = @{
    "@odata.type" = "#microsoft.graph.unifiedRoleManagementPolicyExpirationRule"
    id = $expirationRule.Id
    isExpirationRequired = $false
    maximumDuration = $null
}

Update-MgPolicyRoleManagementPolicyRule `
    -UnifiedRoleManagementPolicyId $readerPolicy.Id `
    -UnifiedRoleManagementPolicyRuleId $expirationRule.Id `
    -BodyParameter $params

Write-Host "PIM rule updated successfully!" -ForegroundColor Green
