trigger: none

name: Deploy_PIMAssignment

variables:
  azureServiceConnection: 'ctb-ac-sc-mb-graph'
  powershellFile: './CTB/TemplateFiles/PowershellSpts/PIMAssignment.ps1'

pool:
  name: Merchantss

stages:
- stage: RunGraphScript
  jobs:
  - job: InstallAndRun
    steps:
    - task: AzurePowerShell@5
      name: GetAccessToken
      inputs:
        azureSubscription: $(azureServiceConnection)
        ScriptType: 'InlineScript'
        azurePowerShellVersion: 'LatestVersion'
        pwsh: true
        Inline: |
          $token = (Get-AzAccessToken -ResourceUrl "https://graph.microsoft.com").Token
          Write-Host "##vso[task.setvariable variable=GraphAccessToken;issecret=true]$token"

    - task: PowerShell@2
      displayName: 'Install Graph Modules & Run Script'
      inputs:
        targetType: 'inline'
        pwsh: true
        script: |
          # Install required Microsoft Graph modules
          Install-Module Microsoft.Graph.Authentication -Force -Scope CurrentUser
          Install-Module Microsoft.Graph.Groups -Force -Scope CurrentUser
          Install-Module Microsoft.Graph.Beta.Identity.Governance -Force -Scope CurrentUser

          # Secure the token
          $secureToken = ConvertTo-SecureString -String "$(GraphAccessToken)" -AsPlainText -Force

          # Connect to Microsoft Graph
          Connect-MgGraph -AccessToken $secureToken -NoWelcome
          Select-MgProfile -Name "beta"

          # Run your main script
          . "$(Build.SourcesDirectory)/CTB/TemplateFiles/PowershellSpts/PIMAssignment.ps1" `
              -AccessPackageName "PackageName" `
              -AccessPackageDescription "Description" `
              -CatalogName "CatalogName" `
              -GroupDisplayNames @("Group1", "Group2") `
              -PrimaryApproverDisplayNames @("Approver1", "Approver2")
