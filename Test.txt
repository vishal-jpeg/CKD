# 1. Define your inputs
$namespaceId    = "2e9eb7ed-3c0a-47d4-87c1-0ffdd275fd87"
$repoToken      = "repoV2/$($ProjectDetails.id)/$repold"
$subject        = $groupDescriptor
$org            = "https://dev.azure.com/cantirebank/"

$permissionsToCheck = @(
    "Advanced Security: manage and dismiss alerts",
    "Advanced Security: manage settings",
    "Advanced Security: view alerts",
    "Read"
)

# 2. Pull back _all_ permissions at once
Write-Host "Fetching all permissions..."
$jsonText = az devops security permission namespace show `
    --namespace-id  $namespaceId `
    --subject       $subject `
    --token         $repoToken `
    --organization  $org `
    --output        json

$allPerms = $jsonText | ConvertFrom-Json

# 3. Loop over each friendly name and look it up
foreach ($permName in $permissionsToCheck) {
    Write-Host "`nChecking permission: $permName"
    
    # Find the matching entry (if any)
    $entry = $allPerms | Where-Object { $_.permissionDisplayName -eq $permName }
    
    if (-not $entry) {
        Write-Host "  ‚ö†Ô∏è  [$permName] is NOT SET"
        continue
    }
    
    # Inspect allow/deny bits
    if ($entry.allow -gt 0) {
        Write-Host "  ‚úÖ [$permName] is ALLOWED (allow = $($entry.allow))"
    }
    elseif ($entry.deny -gt 0) {
        Write-Host "  üö´ [$permName] is DENIED (deny = $($entry.deny))"
    }
    else {
        Write-Host "  ‚ö†Ô∏è  [$permName] exists but neither allow nor deny is set"
    }
}
