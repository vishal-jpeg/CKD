$csvRows = Import‑Csv 'eligibility‑requests.csv'

foreach ($row in $csvRows | Where RequestType -eq 'AdminAssign') {
    # 1. Look for an existing schedule for this principal+role+scope
    $existing = Get‑AzRoleEligibilityScheduleRequest `
       -Filter "PrincipalId eq '$($row.PrincipalId)' and `
               + "RoleDefinitionId eq '$($row.RoleDefinitionId)' and `
               + "DirectoryScopeId eq '$($row.Scope)'" `
       -ErrorAction SilentlyContinue

    if ($existing) {
        Write‑Verbose "Already exists, skipping: $($row.PrincipalId) @ $($row.Scope)"
        continue   # ← skips into next CSV row
    }

    # 2. Only new entries land here, so create them
    New‑AzRoleEligibilityScheduleRequest `
      -Name             ([Guid]::NewGuid().ToString()) `
      -Scope            $row.Scope `
      -PrincipalId      $row.PrincipalId `
      -RoleDefinitionId $row.RoleDefinitionId `
      -RequestType      AdminAssign `
      -StartDateTime    $row.StartDateTime `
      -Duration         $row.Duration `
      -Justification    $row.Justification `
      -ErrorAction      Stop
}
