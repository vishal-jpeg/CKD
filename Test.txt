trigger:
  none

name: Deploy pwsh files

variables:
  azureServiceConnection: 'ctb-ac-sc-mb-graph'
  powershellFile: './CTB/TemplateFiles/PowershellSpts/PIMAssignment.ps1'
  keyVaultName: 'your-keyvault-name'       # Add your Key Vault name here
  secretName: 'ServiceAccountPassword'     # Name of the secret in Key Vault

pool:
  name: Merchantss

stages:
- stage: PowershellCodeExecution
  jobs:
  - job: PowershellCodeExecution
    displayName: Powershell Scripts
    steps:

    # Step 1: Fetch secret from Key Vault
    - task: AzureKeyVault@2
      inputs:
        azureSubscription: $(azureServiceConnection)
        KeyVaultName: $(keyVaultName)
        SecretsFilter: $(secretName)
        RunAsPreJob: true

    # Step 2: Execute PowerShell script using the secret
    - task: AzurePowerShell@5
      inputs:
        ScriptType: 'FilePath'
        azureSubscription: $(azureServiceConnection)
        ScriptPath: $(powershellFile)
        azurePowerShellVersion: latestVersion
        pwsh: false
